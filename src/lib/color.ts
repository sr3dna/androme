const X11_CSS3 = {
    'Pink':                 { 'hex': '#FFC0CB' },
    'LightPink':            { 'hex': '#FFB6C1' },
    'HotPink':              { 'hex': '#FF69B4' },
    'DeepPink':             { 'hex': '#FF1493' },
    'PaleVioletRed':        { 'hex': '#DB7093' },
    'MediumVioletRed':      { 'hex': '#C71585' },
    'LightSalmon':          { 'hex': '#FFA07A' },
    'Salmon':               { 'hex': '#FA8072' },
    'DarkSalmon':           { 'hex': '#E9967A' },
    'LightCoral':           { 'hex': '#F08080' },
    'IndianRed':            { 'hex': '#CD5C5C' },
    'Crimson':              { 'hex': '#DC143C' },
    'Firebrick':            { 'hex': '#B22222' },
    'DarkRed':              { 'hex': '#8B0000' },
    'Red':                  { 'hex': '#FF0000' },
    'OrangeRed':            { 'hex': '#FF4500' },
    'Tomato':               { 'hex': '#FF6347' },
    'Coral':                { 'hex': '#FF7F50' },
    'Orange':               { 'hex': '#FFA500' },
    'DarkOrange':           { 'hex': '#FF8C00' },
    'Yellow':               { 'hex': '#FFFF00' },
    'LightYellow':          { 'hex': '#FFFFE0' },
    'LemonChiffon':         { 'hex': '#FFFACD' },
    'LightGoldenrodYellow': { 'hex': '#FAFAD2' },
    'PapayaWhip':           { 'hex': '#FFEFD5' },
    'Moccasin':             { 'hex': '#FFE4B5' },
    'PeachPuff':            { 'hex': '#FFDAB9' },
    'PaleGoldenrod':        { 'hex': '#EEE8AA' },
    'Khaki':                { 'hex': '#F0E68C' },
    'DarkKhaki':            { 'hex': '#BDB76B' },
    'Gold':                 { 'hex': '#FFD700' },
    'Cornsilk':             { 'hex': '#FFF8DC' },
    'BlanchedAlmond':       { 'hex': '#FFEBCD' },
    'Bisque':               { 'hex': '#FFE4C4' },
    'NavajoWhite':          { 'hex': '#FFDEAD' },
    'Wheat':                { 'hex': '#F5DEB3' },
    'Burlywood':            { 'hex': '#DEB887' },
    'Tan':                  { 'hex': '#D2B48C' },
    'RosyBrown':            { 'hex': '#BC8F8F' },
    'SandyBrown':           { 'hex': '#F4A460' },
    'Goldenrod':            { 'hex': '#DAA520' },
    'DarkGoldenrod':        { 'hex': '#B8860B' },
    'Peru':                 { 'hex': '#CD853F' },
    'Chocolate':            { 'hex': '#D2691E' },
    'SaddleBrown':          { 'hex': '#8B4513' },
    'Sienna':               { 'hex': '#A0522D' },
    'Brown':                { 'hex': '#A52A2A' },
    'Maroon':               { 'hex': '#800000' },
    'DarkOliveGreen':       { 'hex': '#556B2F' },
    'Olive':                { 'hex': '#808000' },
    'OliveDrab':            { 'hex': '#6B8E23' },
    'YellowGreen':          { 'hex': '#9ACD32' },
    'LimeGreen':            { 'hex': '#32CD32' },
    'Lime':                 { 'hex': '#00FF00' },
    'LawnGreen':            { 'hex': '#7CFC00' },
    'Chartreuse':           { 'hex': '#7FFF00' },
    'GreenYellow':          { 'hex': '#ADFF2F' },
    'SpringGreen':          { 'hex': '#00FF7F' },
    'MediumSpringGreen':    { 'hex': '#00FA9A' },
    'LightGreen':           { 'hex': '#90EE90' },
    'PaleGreen':            { 'hex': '#98FB98' },
    'DarkSeaGreen':         { 'hex': '#8FBC8F' },
    'MediumAquamarine':     { 'hex': '#66CDAA' },
    'MediumSeaGreen':       { 'hex': '#3CB371' },
    'SeaGreen':             { 'hex': '#2E8B57' },
    'ForestGreen':          { 'hex': '#228B22' },
    'Green':                { 'hex': '#008000' },
    'DarkGreen':            { 'hex': '#006400' },
    'Aqua':                 { 'hex': '#00FFFF' },
    'Cyan':                 { 'hex': '#00FFFF' },
    'LightCyan':            { 'hex': '#E0FFFF' },
    'PaleTurquoise':        { 'hex': '#AFEEEE' },
    'Aquamarine':           { 'hex': '#7FFFD4' },
    'Turquoise':            { 'hex': '#40E0D0' },
    'DarkTurquoise':        { 'hex': '#00CED1' },
    'MediumTurquoise':      { 'hex': '#48D1CC' },
    'LightSeaGreen':        { 'hex': '#20B2AA' },
    'CadetBlue':            { 'hex': '#5F9EA0' },
    'DarkCyan':             { 'hex': '#008B8B' },
    'Teal':                 { 'hex': '#008080' },
    'LightSteelBlue':       { 'hex': '#B0C4DE' },
    'PowderBlue':           { 'hex': '#B0E0E6' },
    'LightBlue':            { 'hex': '#ADD8E6' },
    'SkyBlue':              { 'hex': '#87CEEB' },
    'LightSkyBlue':         { 'hex': '#87CEFA' },
    'DeepSkyBlue':          { 'hex': '#00BFFF' },
    'DodgerBlue':           { 'hex': '#1E90FF' },
    'Cornflower':           { 'hex': '#6495ED' },
    'SteelBlue':            { 'hex': '#4682B4' },
    'RoyalBlue':            { 'hex': '#4169E1' },
    'Blue':                 { 'hex': '#0000FF' },
    'MediumBlue':           { 'hex': '#0000CD' },
    'DarkBlue':             { 'hex': '#00008B' },
    'Navy':                 { 'hex': '#000080' },
    'MidnightBlue':         { 'hex': '#191970' },
    'Lavender':             { 'hex': '#E6E6FA' },
    'Thistle':              { 'hex': '#D8BFD8' },
    'Plum':                 { 'hex': '#DDA0DD' },
    'Violet':               { 'hex': '#EE82EE' },
    'Orchid':               { 'hex': '#DA70D6' },
    'Fuchsia':              { 'hex': '#FF00FF' },
    'Magenta':              { 'hex': '#FF00FF' },
    'MediumOrchid':         { 'hex': '#BA55D3' },
    'MediumPurple':         { 'hex': '#9370DB' },
    'BlueViolet':           { 'hex': '#8A2BE2' },
    'DarkViolet':           { 'hex': '#9400D3' },
    'DarkOrchid':           { 'hex': '#9932CC' },
    'DarkMagenta':          { 'hex': '#8B008B' },
    'Purple':               { 'hex': '#800080' },
    'RebeccaPurple':        { 'hex': '#663399' },
    'Indigo':               { 'hex': '#4B0082' },
    'DarkSlateBlue':        { 'hex': '#483D8B' },
    'SlateBlue':            { 'hex': '#6A5ACD' },
    'MediumSlateBlue':      { 'hex': '#7B68EE' },
    'White':                { 'hex': '#FFFFFF' },
    'Snow':                 { 'hex': '#FFFAFA' },
    'Honeydew':             { 'hex': '#F0FFF0' },
    'MintCream':            { 'hex': '#F5FFFA' },
    'Azure':                { 'hex': '#F0FFFF' },
    'AliceBlue':            { 'hex': '#F0F8FF' },
    'GhostWhite':           { 'hex': '#F8F8FF' },
    'WhiteSmoke':           { 'hex': '#F5F5F5' },
    'Seashell':             { 'hex': '#FFF5EE' },
    'Beige':                { 'hex': '#F5F5DC' },
    'OldLace':              { 'hex': '#FDF5E6' },
    'FloralWhite':          { 'hex': '#FFFAF0' },
    'Ivory':                { 'hex': '#FFFFF0' },
    'AntiqueWhite':         { 'hex': '#FAEBD7' },
    'Linen':                { 'hex': '#FAF0E6' },
    'LavenderBlush':        { 'hex': '#FFF0F5' },
    'MistyRose':            { 'hex': '#FFE4E1' },
    'Gainsboro':            { 'hex': '#DCDCDC' },
    'LightGray':            { 'hex': '#D3D3D3' },
    'Silver':               { 'hex': '#C0C0C0' },
    'DarkGray':             { 'hex': '#A9A9A9' },
    'Gray':                 { 'hex': '#808080' },
    'DimGray':              { 'hex': '#696969' },
    'LightSlateGray':       { 'hex': '#778899' },
    'SlateGray':            { 'hex': '#708090' },
    'DarkSlateGray':        { 'hex': '#2F4F4F' },
    'Black':                { 'hex': '#000000' }
};

const HSL_SORTED: Color[] = [];

for (const name in X11_CSS3) {
    const x11: Color = X11_CSS3[name];
    x11.name = name;
    const rgba = convertRGBA(x11.hex);
    if (rgba) {
        x11.rgba = rgba;
        x11.hsl = convertHSL(x11.rgba);
        HSL_SORTED.push(x11);
    }
}

HSL_SORTED.sort(sortHSL);

function convertHSL({ r = 0, g = 0, b = 0 }) {
    r = r / 255;
    g = g / 255;
    b = b / 255;
    const min = Math.min(r, g, b);
    const max = Math.max(r, g, b);
    let h = (max + min) / 2;
    let s = h;
    const l = h;
    if (max === min) {
        h = 0;
        s = 0;
    }
    else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r:
                h = (g - b) / d + (g < b ? 6 : 0);
                break;
            case g:
                h = (b - r) / d + 2;
                break;
            case b:
                h = (r - g) / d + 4;
                break;
        }
        h /= 6;
    }
    return {
        h: h * 360,
        s: s * 100,
        l: l * 100
    };
}

function sortHSL(a: Color, b: Color) {
    if (a.hsl && b.hsl) {
        let [c, d] = [a.hsl.h, b.hsl.h];
        if (c === d) {
            [c, d] = [a.hsl.s, b.hsl.s];
            if (c === d) {
                [c, d] = [a.hsl.l, b.hsl.l];
            }
        }
        return c >= d ? 1 : -1;
    }
    return 0;
}

function formatRGBA(rgba: RGBA) {
    return `rgb${rgba.a < 1 ? 'a' : ''}(${rgba.r}, ${rgba.g}, ${rgba.b}${rgba.a < 1 ? `, ${rgba.a.toFixed(2)}` : ''})`;
}

function getHexAlpha(value: string) {
    return parseFloat(value) < 1 ? convertHex('255', parseFloat(value)) : 'FF';
}

export function getColorByName(value: string) {
    for (const color in X11_CSS3) {
        if (color.toLowerCase() === value.trim().toLowerCase()) {
            return <Color> X11_CSS3[color];
        }
    }
    return null;
}

export function getColorNearest(value: string) {
    const result = HSL_SORTED.slice();
    let index = result.findIndex(item => item.hex === value);
    if (index !== -1) {
        return result[index];
    }
    else {
        const rgb = convertRGBA(value);
        if (rgb) {
            const hsl = convertHSL(rgb);
            if (hsl) {
                result.push({
                    name: '',
                    hsl,
                    rgba: { r: -1, g: -1, b: -1, a: 1 },
                    hex: ''
                });
                result.sort(sortHSL);
                index = result.findIndex(item => item.name === '');
                return result[Math.min(index + 1, result.length - 1)];
            }
        }
        return null;
    }
}

export function convertHex(value: string, opacity = 1) {
    const hex = '0123456789ABCDEF';
    let rgb = parseInt(value) * opacity;
    if (isNaN(rgb)) {
        return '00';
    }
    rgb = Math.max(0, Math.min(rgb, 255));
    return hex.charAt((rgb - (rgb % 16)) / 16) + hex.charAt(rgb % 16);
}

export function convertRGBA(value: string): Null<RGBA> {
    value = value.replace(/#/g, '').trim();
    if (/[A-Za-z\d]{3,}/.test(value)) {
        let a = 1;
        switch (value.length) {
            case 4:
                a = parseInt(value.charAt(3).repeat(2), 16);
            case 3:
                value = value.charAt(0).repeat(2) + value.charAt(1).repeat(2) + value.charAt(2).repeat(2);
                break;
            case 5:
                value += value.charAt(4);
                break;
            default:
                value = value.substring(0, 6);
                if (value.length >= 8) {
                    a = parseInt(value.substring(6, 8), 16);
                }
                break;
        }
        if (value.length === 6) {
            return {
                r: parseInt(value.substring(0, 2), 16),
                g: parseInt(value.substring(2, 4), 16),
                b: parseInt(value.substring(4), 16),
                a
            };
        }
    }
    return null;
}

export function parseRGBA(value: string, opacity = '1'): Null<ColorHexAlpha> {
    if (value && value !== 'initial' && value !== 'transparent') {
        if (value.charAt(0) === '#') {
            const rgba = convertRGBA(value);
            if (rgba) {
                value = formatRGBA(rgba);
            }
        }
        else if (!value.startsWith('rgb')) {
            const color = getColorByName(value);
            if (color && color.rgba) {
                color.rgba.a = parseFloat(opacity);
                value = formatRGBA(color.rgba);
            }
        }
        const match = value.match(/rgba?\((\d+), (\d+), (\d+),?\s*([\d.]+)?\)/);
        if (match && match.length >= 4 && (match[4] == null || parseFloat(match[4]) > 0)) {
            if (match[4] == null) {
                match[4] = parseFloat(opacity).toFixed(2);
            }
            const valueHex = convertHex(match[1]) + convertHex(match[2]) + convertHex(match[3]);
            const valueA = getHexAlpha(match[4]);
            const valueRGBA = `#${valueHex + valueA}`;
            const alpha = parseFloat(match[4]);
            return {
                valueRGB: `#${valueHex}`,
                valueRGBA,
                valueARGB: `#${valueA + valueHex}`,
                alpha,
                rgba: convertRGBA(valueRGBA) as RGBA,
                opaque: alpha < 1,
                visible: alpha > 0
            };
        }
    }
    return null;
}

export function reduceRGBA(value: string, percent: number) {
    const rgba = convertRGBA(value);
    if (rgba) {
        const base = percent < 0 ? 0 : 255;
        percent = Math.abs(percent);
        rgba.r = Math.round((base - rgba.r) * percent) + rgba.r;
        rgba.g = Math.round((base - rgba.g) * percent) + rgba.g;
        rgba.b = Math.round((base - rgba.b) * percent) + rgba.b;
        return formatRGBA(rgba);
    }
    return value;
}